<!DOCTYPE html>
<html>
<head>
  <meta charset="iso-8859-1">
  <title>Générer un Email</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f6f8fa;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      margin-top: 30px;
      color: #222;
      letter-spacing: 1px;
    }
    form {
      background: #fff;
      max-width: 900px;
      margin: 30px auto 40px auto;
      padding: 32px 36px 24px 36px;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1.5px 4px rgba(0,0,0,0.03);
    }
    label {
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
      display: block;
    }
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      padding: 8px 12px;
      margin-top: 2px;
      margin-bottom: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
      background: #fafbfc;
      transition: border 0.2s;
    }
    input:focus, select:focus {
      border: 1.5px solid #4472C4;
      outline: none;
      background: #fff;
    }
    .client-section {
      margin-bottom: 32px;
      border: 1.5px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px 20px 16px 20px;
      background: #fcfcfd;
      box-shadow: 0 2px 8px rgba(68,114,196,0.04);
      position: relative;
    }
    .client-section h3 {
      margin-top: 0;
      margin-bottom: 18px;
      color: #4472C4;
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    .client-section h4 {
      margin-bottom: 10px;
      color: #333;
      font-size: 1.05rem;
      font-weight: 500;
    }
    .delete-client-btn {
      background: #fff0f0;
      color: #c71553;
      border: 1px solid #f3c2d3;
      border-radius: 6px;
      padding: 7px 16px;
      font-size: 0.98rem;
      font-weight: 500;
      margin-top: 8px;
      margin-bottom: 0;
      float: right;
      transition: background 0.2s, color 0.2s;
    }
    .delete-client-btn:hover {
      background: #ffe5e5;
      color: #a00;
      border-color: #e5a2b3;
    }
    .productsTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 12px;
      background: #f8fafc;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(68,114,196,0.04);
    }
    .productsTable th {
      background: #4472C4;
      color: #fff;
      font-weight: 600;
      padding: 8px 6px;
      border: none;
      font-size: 1rem;
    }
    .productsTable td {
      padding: 7px 6px;
      border-bottom: 1px solid #e5e7eb;
      background: #fff;
    }
    .productsTable tr:last-child td {
      border-bottom: none;
    }
    .productsTable input {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      border-radius: 5px;
      border: 1px solid #d1d5db;
      background: #f6f8fa;
      font-size: 0.98rem;
    }
    .productsTable input:focus {
      border: 1.5px solid #4472C4;
      background: #fff;
    }
    button[type="button"] {
      background: #4472C4;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 8px 18px;
      font-size: 1rem;
      font-weight: 500;
      margin-top: 8px;
      margin-bottom: 8px;
      margin-right: 8px;
      box-shadow: 0 1px 4px rgba(68,114,196,0.07);
      transition: background 0.2s, color 0.2s;
    }
    button[type="button"]:hover {
      background: #3557a6;
      color: #fff;
    }
    button[type="submit"] {
      background: #70ad46;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 28px;
      font-size: 1.08rem;
      font-weight: 600;
      margin-top: 18px;
      margin-bottom: 0;
      box-shadow: 0 2px 8px rgba(112,173,70,0.08);
      transition: background 0.2s, color 0.2s;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    button[type="submit"]:hover {
      background: #5b8e38;
      color: #fff;
    }
    @media (max-width: 700px) {
      form {
        padding: 16px 4vw 16px 4vw;
      }
      .client-section {
        padding: 14px 4vw 10px 4vw;
      }
      .productsTable th, .productsTable td {
        font-size: 0.97rem;
        padding: 6px 2px;
      }
    }
  </style>
</head>
<body>
  <h1>Générer un Email</h1>

  <form action="/template/generate" method="POST" id="emailForm">
    <!-- ENTREPRISE DROPDOWN & COULEURS -->
    <label for="company">Entreprise :</label>
    <select id="company" name="company" onchange="setCompanyColors()" required>
      <option  selected>Veuillez Selectionner une Entreprise </option>
      <option value="canpol" >Canpol</option>
      <option value="beureur">Beurer</option>
      <option value="titania">Titania</option>
      <option value="techwood">Techwood</option>
      <option value="naturtint">Naturtint</option>
      <option value="polarbox">Polarbox</option>
    </select>
    <br><br>

    <!-- Champs cachés pour stocker les couleurs choisies pour l'entête du tableau -->
    <input type="hidden" id="tableBackground" name="tableBackground" value="black" />
    <input type="hidden" id="tableColor" name="tableColor" value="#4472C4" />

    <div id="clientsContainer">
      <div class="client-section">
        <h3>Client 1</h3>
        <label>Nom du client :</label>
        <input type="text" name="clients[0][client_name]" required />
        <br><br>

        <label>Téléphone :</label>
        <input type="text" name="clients[0][phone]" required />
        <br><br>

        <label>Adresse :</label>
        <input type="text" name="clients[0][address]" required />
        <br><br>

        <label>Frais de Livraison :</label>
        <input type="number" name="clients[0][order_livr]" oninput="calculateAllTotals()" min="0" step="0.01" required />
        <br><br>

        <label>Timbre Fiscal :</label>
        <input type="number" name="clients[0][order_tbr]" oninput="calculateAllTotals()" min="0" step="0.01" required />
        <br><br>

        <h4>Produits :</h4>
        <table class="productsTable">
          <thead>
            <tr>
              <th>Code Saari</th>
              <th>Nom du Produit</th>
              <th>Quantité</th>
              <th>Prix TTC</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" name="clients[0][products][0][product_code]" required /></td>
              <td><input type="text" name="clients[0][products][0][product_name]" required /></td>
              <td><input type="number" name="clients[0][products][0][quantity]" value="1" oninput="calculateAllTotals()" min="1" required /></td>
              <td><input type="number" name="clients[0][products][0][price_ttc]" oninput="calculateAllTotals()" min="0" step="0.001" required /></td>
              <td><button type="button" onclick="removeProductRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" onclick="addProductRow(this)">Ajouter un Produit</button>
        <br><br>

        <label>Total Général de la Commande :</label>
        <input type="number" name="clients[0][order_grand_total]" readonly />
        <br><br>
        <!-- Only show delete button for clients with index > 0 -->
        <!-- The first client (index 0) does not get a delete button -->
      </div>
    </div>
    <button type="button" onclick="addClientSection()">Ajouter un nouveau client</button>
    <br><br>
    <button type="submit">Générer Email</button>
  </form>

  <script>
    let clientIndex = 1; // Starts at 1 since Client 1 is already present

    function setCompanyColors() {
      const companySelect = document.getElementById('company');
      const backgroundInput = document.getElementById('tableBackground');
      const colorInput = document.getElementById('tableColor');

      switch (companySelect.value) {
        case 'canpol':
          backgroundInput.value = 'black';
          colorInput.value = '#4472C4';
          break;
        case 'beureur':
          backgroundInput.value = '#c71553';
          colorInput.value = '#ffffff';
          break;
        case 'titania':
          backgroundInput.value = '#ffbaa0';
          colorInput.value = 'black';
          break;
        case 'techwood':
          backgroundInput.value = '#FF0000';
          colorInput.value = '#FFFFFF';
          break;
        case 'naturtint':
          backgroundInput.value = '#70ad46';
          colorInput.value = '#000000';
          break;
        case 'polarbox':
          backgroundInput.value = '#ffff00';
          colorInput.value = '#577b84';
          break;
        default:
          backgroundInput.value = 'black';
          colorInput.value = '#4472C4';  
      }
    }

    function addClientSection() {
      const clientsContainer = document.getElementById('clientsContainer');
      const newClientSection = document.createElement('div');
      newClientSection.className = 'client-section';
      const currentClientIndex = clientIndex;

      newClientSection.innerHTML = `
        <h3>Client ${currentClientIndex + 1}</h3>
        <label>Nom du client :</label>
        <input type="text" name="clients[${currentClientIndex}][client_name]" required />
        <br><br>

        <label>Téléphone :</label>
        <input type="text" name="clients[${currentClientIndex}][phone]" required />
        <br><br>

        <label>Adresse :</label>
        <input type="text" name="clients[${currentClientIndex}][address]" required />
        <br><br>

        <label>Frais de Livraison :</label>
        <input type="number" name="clients[${currentClientIndex}][order_livr]" oninput="calculateAllTotals()" min="0" step="0.01" required />
        <br><br>

        <label>Timbre Fiscal :</label>
        <input type="number" name="clients[${currentClientIndex}][order_tbr]" oninput="calculateAllTotals()" min="0" step="0.01" required />
        <br><br>

        <h4>Produits :</h4>
        <table class="productsTable">
          <thead>
            <tr>
              <th>Code Saari</th>
              <th>Nom du Produit</th>
              <th>Quantité</th>
              <th>Prix TTC</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="text" name="clients[${currentClientIndex}][products][0][product_code]" required /></td>
              <td><input type="text" name="clients[${currentClientIndex}][products][0][product_name]" required /></td>
              <td><input type="number" name="clients[${currentClientIndex}][products][0][quantity]" value="1" oninput="calculateAllTotals()" min="1" required /></td>
              <td><input type="number" name="clients[${currentClientIndex}][products][0][price_ttc]" oninput="calculateAllTotals()" min="0" step="0.001" required /></td>
              <td><button type="button" onclick="removeProductRow(this)">Supprimer</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" onclick="addProductRow(this)">Ajouter un Produit</button>
        <br><br>

        <label>Total Général de la Commande :</label>
        <input type="number" name="clients[${currentClientIndex}][order_grand_total]" readonly />
        <br><br>
        <button type="button" onclick="removeClientSection(this)" class="delete-client-btn">Supprimer ce client</button>
      `;

      clientsContainer.appendChild(newClientSection);
      clientIndex++;
      calculateAllTotals();
    }

    function addProductRow(button) {
      const clientSection = button.closest('.client-section');
      const tableBody = clientSection.querySelector('.productsTable tbody');
      const currentRowCount = tableBody.rows.length;
      const clientIdMatch = Array.from(clientSection.querySelectorAll('input[name^="clients["]'))[0].name.match(/clients\[(\d+)\]/);
      const clientId = clientIdMatch ? clientIdMatch[1] : 0;

      const newRow = document.createElement('tr');
      newRow.innerHTML = `
        <td><input type="text" name="clients[${clientId}][products][${currentRowCount}][product_code]" required /></td>
        <td><input type="text" name="clients[${clientId}][products][${currentRowCount}][product_name]" required /></td>
        <td><input type="number" name="clients[${clientId}][products][${currentRowCount}][quantity]" value="1" oninput="calculateAllTotals()" min="1" required /></td>
        <td><input type="number" name="clients[${clientId}][products][${currentRowCount}][price_ttc]" oninput="calculateAllTotals()" min="0" step="0.001" required /></td>
        <td><button type="button" onclick="removeProductRow(this)">Supprimer</button></td>
      `;
      tableBody.appendChild(newRow);
      calculateAllTotals();
    }

    function removeProductRow(button) {
      const row = button.closest("tr");
      const tableBody = row.parentNode;
      row.remove();
      calculateAllTotals();

      // Reindex product rows
      const clientSection = button.closest('.client-section');
      const clientIdMatch = Array.from(clientSection.querySelectorAll('input[name^="clients["]'))[0].name.match(/clients\[(\d+)\]/);
      const clientId = clientIdMatch ? clientIdMatch[1] : 0;
      const rows = tableBody.querySelectorAll('tr');
      rows.forEach((tr, index) => {
        tr.querySelectorAll('input').forEach(input => {
          const name = input.getAttribute('name');
          const newName = name.replace(/products\[\d+\]/, `products[${index}]`);
          input.setAttribute('name', newName);
        });
      });
      calculateAllTotals();
    }

    function calculateAllTotals() {
      const clientSections = document.querySelectorAll('.client-section');

      clientSections.forEach(section => {
        const products = section.querySelectorAll('.productsTable tbody tr');
        let subtotal = 0;

        products.forEach(row => {
          const quantityInput = row.querySelector('input[name*="[quantity]"]');
          const priceInput = row.querySelector('input[name*="[price_ttc]"]');

          const quantity = parseFloat(quantityInput.value) || 0;
          const price = parseFloat(priceInput.value) || 0;

          subtotal += quantity * price;
        });

        const deliveryInput = section.querySelector('input[name*="[order_livr]"]');
        const fiscalStampInput = section.querySelector('input[name*="[order_tbr]"]');

        const delivery = parseFloat(deliveryInput.value) || 0;
        const fiscalStamp = parseFloat(fiscalStampInput.value) || 0;

        const grandTotal = subtotal + delivery + fiscalStamp;

        const grandTotalInput = section.querySelector('input[name*="[order_grand_total]"]');
        grandTotalInput.value = grandTotal.toFixed(2);
      });
    }

    function removeClientSection(button) {
      const clientsContainer = document.getElementById('clientsContainer');
      const clientSections = clientsContainer.querySelectorAll('.client-section');
      if (clientSections.length <= 1) {
        // Do not delete if only one client section remains
        return;
      }
      const clientSection = button.closest('.client-section');
      clientSection.remove();
      calculateAllTotals();
    }

    // Initial calculation on page load
    window.onload = calculateAllTotals;
  </script>
</body>
</html>











